#!/bin/sh
set -e

CONFIG_ROOT="${XDG_CONFIG_HOME:-$HOME/.config}"
ENV_FILE="$CONFIG_ROOT/.env"
ENV_KEYS="$CONFIG_ROOT/.env.keys"
ENV_LOCAL="$CONFIG_ROOT/.env.local"

# Check if .env exists
if [ ! -f "$ENV_FILE" ]; then
  echo "Error: $ENV_FILE not found" >&2
  exit 1
fi

# Check if .env.keys exists
if [ ! -f "$ENV_KEYS" ]; then
  echo "Error: $ENV_KEYS not found. Restore from 1Password:" >&2
  echo "  op document get \"dotfiles-env-keys\" --output ~/.config/.env.keys" >&2
  exit 1
fi

# Update check: decrypt only if .env is newer than .env.local
if [ -f "$ENV_LOCAL" ]; then
  if [ "$ENV_FILE" -nt "$ENV_LOCAL" ]; then
    echo "Updating .env.local (detected changes in .env)..."
  else
    # .env.local is up-to-date
    exit 0
  fi
else
  echo "Generating .env.local for the first time..."
fi

# Decrypt .env to .env.local (use temp file for atomicity)
TEMP_FILE="$ENV_LOCAL.tmp"
if dotenvx decrypt "$ENV_FILE" --stdout > "$TEMP_FILE"; then
  mv "$TEMP_FILE" "$ENV_LOCAL"
  echo "âœ“ .env.local updated successfully"
else
  rm -f "$TEMP_FILE"
  echo "Error: Failed to decrypt .env" >&2
  exit 1
fi
