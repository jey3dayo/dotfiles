#!/usr/bin/env bash
set -euo pipefail

# Explicitly add mise/pnpm/npm to PATH
export PATH="$HOME/.local/bin:$PATH"

logdir="${XDG_CACHE_HOME:-$HOME/.cache}/openclaw"
mkdir -p "$logdir"
log="$logdir/cleanup.log"

{
  echo "=== openclaw-cleanup $(date -Is) ==="
  echo "host=$(hostname) user=$USER"
  echo "PATH=$PATH" # PATH確認用
  echo "--- df (before) ---"
  df -h /

  echo "--- mise prune ---"
  if command -v mise >/dev/null 2>&1; then
    mise prune -y || true
  else
    echo "mise: not found"
  fi

  echo "--- pnpm store prune ---"
  if command -v pnpm >/dev/null 2>&1; then
    pnpm store prune || true
  else
    echo "pnpm: not found"
  fi

  echo "--- npm cache clean ---"
  if command -v npm >/dev/null 2>&1; then
    npm cache clean --force 2>&1 | grep -v "npm warn" || true
  else
    echo "npm: not found"
  fi

  echo "--- df (after) ---"
  df -h /
  echo "=== done ==="
} >>"$log" 2>&1

echo "Log: $log"
