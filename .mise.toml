# ========================================
# ~/.config 配下のみで有効にする mise タスク
# プロジェクト固有の集約・mac依存タスクをここで定義
# ========================================

# ========================================
# Environment Variable Management (dotenvx)
# ========================================

[tasks."setup-env"]
description = ".env を .env.local に復号化（mise hooks から自動実行）"
run = """
#!/bin/sh
set -e

CONFIG_ROOT="${XDG_CONFIG_HOME:-$HOME/.config}"
ENV_FILE="$CONFIG_ROOT/.env"
ENV_KEYS="$CONFIG_ROOT/.env.keys"
ENV_LOCAL="$CONFIG_ROOT/.env.local"

# Check if .env exists
if [ ! -f "$ENV_FILE" ]; then
  echo "Error: $ENV_FILE not found" >&2
  exit 1
fi

# Check if .env.keys exists
if [ ! -f "$ENV_KEYS" ]; then
  echo "Error: $ENV_KEYS not found. Restore from 1Password:" >&2
  echo "  op document get \\"dotfiles-env-keys\\" --output ~/.config/.env.keys" >&2
  exit 1
fi

# Update check: decrypt only if .env is newer than .env.local
if [ -f "$ENV_LOCAL" ]; then
  if [ "$ENV_FILE" -nt "$ENV_LOCAL" ]; then
    echo "Updating .env.local (detected changes in .env)..."
  else
    # .env.local is up-to-date
    exit 0
  fi
else
  echo "Generating .env.local for the first time..."
fi

# Decrypt .env to .env.local (use temp file for atomicity)
TEMP_FILE="$ENV_LOCAL.tmp"
if dotenvx decrypt "$ENV_FILE" --stdout > "$TEMP_FILE"; then
  mv "$TEMP_FILE" "$ENV_LOCAL"
  echo "✓ .env.local updated successfully"
else
  rm -f "$TEMP_FILE"
  echo "Error: Failed to decrypt .env" >&2
  exit 1
fi
"""

[tasks."env:encrypt"]
description = "環境変数ファイルを暗号化"
run = "dotenvx encrypt -f ~/.config/.env"

[tasks."env:decrypt"]
description = "環境変数ファイルを復号化"
run = "dotenvx decrypt -f ~/.config/.env"

[hooks]
# Decrypt .env to .env.local on directory enter
enter = 'mise run setup-env || true'

# ========================================
# Brewfile 管理
# ========================================

[tasks."brewfile:backup"]
description = "現在のインストール状況をBrewfileに保存（差分あればコミット）"
run = "if command -v brew >/dev/null 2>&1; then brew bundle dump --file=Brewfile --force && git add Brewfile && git diff --cached --quiet || git commit -m 'chore: update Brewfile'; else echo 'Homebrew not installed'; fi"

[tasks."brewfile:restore"]
description = "Brewfileからパッケージをインストール（新規Mac対応）"
run = "if command -v brew >/dev/null 2>&1; then brew bundle install --no-upgrade; else echo 'Homebrew not installed. Install: /bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"'; fi"

# ========================================
# 集約タスク
# ========================================

# 集約タスク（フォーマット系まとめ）
[tasks.format]
description = "コードとドキュメントの自動フォーマット"
depends = [
  "format:biome",
  "format:markdown",
  "format:toml",
  "format:yaml",
  "format:lua",
  "format:shell",
]

[tasks.check]
description = "全フォーマットチェック（書き込みなし、CI向け）- 並列実行"
depends = [
  "format:biome:check",
  "format:markdown:check",
  "format:toml:check",
  "format:yaml:check",
  "format:lua:check",
  "format:shell:check",
]

# 集約タスク（Lintまとめ）
[tasks.lint]
description = "全体の品質チェック（GitHub Actions互換）- 並列実行"
depends = [
  "lint:biome",
  "lint:markdown",
  "lint:toml",
  "lint:yaml",
  "lint:lua",
  "lint:shell",
]

# 更新タスク（mac/local 依存）
[tasks.update]
description = "すべての依存関係を更新"
depends = ["update:submodules", "update:brew", "update:external-repos"]

[tasks."update:submodules"]
description = "Git サブモジュールを最新に更新（ローカル変更を破棄）"
run = "if [ -f .gitmodules ]; then git submodule foreach 'git reset --hard HEAD && git clean -fd' && git submodule update --remote; else echo 'No submodules configured, skipping'; fi"

[tasks."update:brew"]
description = "Homebrew パッケージを更新（formula のみ、cask は除く）"
run = "if command -v brew >/dev/null 2>&1; then (brew update 2>&1 | grep -v \"definition is invalid\" || true) && brew upgrade --formula; else echo 'Homebrew not installed, skipping brew update'; fi"

[tasks."update:external-repos"]
description = "外部 Git リポジトリを更新（強制リセット）"
run = [
  "if [ -d ~/src/github.com/brookhong/Surfingkeys ]; then cd ~/src/github.com/brookhong/Surfingkeys && git fetch origin && git reset --hard origin/master && git clean -fd; else echo 'Skip: ~/src/github.com/brookhong/Surfingkeys not found'; fi",
]

# CI/CD
[tasks.ci]
description = "すべての CI チェックをローカル実行（GitHub Actions と同じ）"
depends = ["format", "lint:docs", "lint:links"]

[tasks."ci:install"]
description = "CI に必要な追加ツールをインストール"
run = "luarocks install --local luacheck"
