# ========================================
# ~/.config 配下のみで有効にする mise タスク
# プロジェクト固有の集約・mac依存タスクをここで定義
# ========================================

# 集約タスク（フォーマット系まとめ）
[tasks.format]
description = "コードとドキュメントの自動フォーマット"
depends = [
  "format:biome",
  "format:markdown",
  "format:toml",
  "format:yaml",
  "format:lua",
  "format:shell",
]

[tasks.check]
description = "全フォーマットチェック（書き込みなし、CI向け）- 並列実行"
depends = [
  "format:biome:check",
  "format:markdown:check",
  "format:toml:check",
  "format:yaml:check",
  "format:lua:check",
  "format:shell:check",
]

# 集約タスク（Lintまとめ）
[tasks.lint]
description = "全体の品質チェック（GitHub Actions互換）- 並列実行"
depends = [
  "lint:biome",
  "lint:markdown",
  "lint:toml",
  "lint:yaml",
  "lint:lua",
  "lint:shell",
]

[tasks."lint:shell"]
description = "シェルスクリプト (.sh/.zsh) をチェック（SH_FILES で対象を限定可能）"
run = """
if [ -n "${SH_FILES:-}" ]; then
  shfmt -d -i 2 -ci -bn ${SH_FILES}
  shellcheck ${SH_FILES}
else
  fd -e sh -X shfmt -d -i 2 -ci -bn
  fd -e sh -X shellcheck
  fd -e zsh . zsh/lazy-sources zsh/sources -X shellcheck
fi
"""

# 更新タスク（mac/local 依存）
[tasks.update]
description = "すべての依存関係を更新"
depends = ["update:submodules", "update:brew", "update:external-repos"]

[tasks."update:submodules"]
description = "Git サブモジュールを最新に更新（ローカル変更を破棄）"
run = "if [ -f .gitmodules ]; then git submodule foreach 'git reset --hard HEAD && git clean -fd' && git submodule update --remote; else echo 'No submodules configured, skipping'; fi"

[tasks."update:brew"]
description = "Homebrew パッケージを更新（formula のみ、cask は除く）"
run = "if command -v brew >/dev/null 2>&1; then (brew update 2>&1 | grep -v \"definition is invalid\" || true) && brew upgrade --formula; else echo 'Homebrew not installed, skipping brew update'; fi"

[tasks."update:external-repos"]
description = "外部 Git リポジトリを更新（強制リセット）"
run = [
  "if [ -d ~/src/github.com/brookhong/Surfingkeys ]; then cd ~/src/github.com/brookhong/Surfingkeys && git fetch origin && git reset --hard origin/master && git clean -fd; else echo 'Skip: ~/src/github.com/brookhong/Surfingkeys not found'; fi",
]

# CI/CD
[tasks.ci]
description = "すべての CI チェックをローカル実行（GitHub Actions と同じ）"
depends = ["format", "lint:links"]

[tasks."ci:install"]
description = "CI に必要な追加ツールをインストール"
run = "luarocks install --local luacheck"
