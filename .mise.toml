# ========================================
# ~/.config é…ä¸‹ã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹ mise ã‚¿ã‚¹ã‚¯
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®é›†ç´„ãƒ»macä¾å­˜ã‚¿ã‚¹ã‚¯ã‚’ã“ã“ã§å®šç¾©
# ========================================

# ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ mise/tasks/ ã‹ã‚‰èª­ã¿è¾¼ã¿
[task_config]
includes = [
  "mise/tasks/format.toml",
  "mise/tasks/lint.toml",
  "mise/tasks/test.toml",
  "mise/tasks/integration.toml",
]

# ========================================
# Environment Variable Management (dotenvx)
# ========================================

[tasks."setup-env"]
description = ".env ã‚’ .env.local ã«å¾©å·åŒ–ï¼ˆmise hooks ã‹ã‚‰è‡ªå‹•å®Ÿè¡Œï¼‰"
run = "scripts/setup-env.sh"

[tasks."env:encrypt"]
description = "ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æš—å·åŒ–"
run = "dotenvx encrypt -f ${XDG_CONFIG_HOME:-$HOME/.config}/.env"

[tasks."env:decrypt"]
description = "ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·åŒ–"
run = "DOTENV_PRIVATE_KEY_PATH=${XDG_CONFIG_HOME:-$HOME/.config}/.env.keys dotenvx decrypt -f ${XDG_CONFIG_HOME:-$HOME/.config}/.env"

[hooks]
# Decrypt .env to .env.local on directory enter (silent on success, show critical errors)
enter = 'mise run setup-env 2>&1 | grep -E "^(âŒ|Error:)" || true'

# ========================================
# Brewfile ç®¡ç†
# ========================================

[tasks."brewfile:backup"]
description = "ç¾åœ¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ³ã‚’Brewfileã«ä¿å­˜ï¼ˆå·®åˆ†ã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆï¼‰"
run = "if command -v brew >/dev/null 2>&1; then brew bundle dump --file=Brewfile --force && git add Brewfile && git diff --cached --quiet || git commit -m 'chore: update Brewfile'; else echo 'Homebrew not installed'; fi"

[tasks."brewfile:restore"]
description = "Brewfileã‹ã‚‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæ–°è¦Macå¯¾å¿œï¼‰"
run = "if command -v brew >/dev/null 2>&1; then brew bundle install --no-upgrade; else echo 'Homebrew not installed. Install: /bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"'; fi"

# ========================================
# æ›´æ–°ã‚¿ã‚¹ã‚¯ï¼ˆmac/local ä¾å­˜ï¼‰
# ========================================
[tasks.update]
description = "ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°"
depends = [
  "update:submodules",
  "update:brew",
  "update:apt",
  "update:external-repos",
]

[tasks."update:submodules"]
description = "Git ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æœ€æ–°ã«æ›´æ–°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ›´ã‚’ç ´æ£„ï¼‰"
run = "if [ -f .gitmodules ]; then git submodule foreach 'git reset --hard HEAD && git clean -fd' && git submodule update --remote; else echo 'No submodules configured, skipping'; fi"

[tasks."update:brew"]
description = "Homebrew ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°ï¼ˆformula ã®ã¿ã€cask ã¯é™¤ãï¼‰"
run = "if command -v brew >/dev/null 2>&1; then (brew update 2>&1 | grep -v \"definition is invalid\" || true) && brew upgrade --formula; else echo 'Homebrew not installed, skipping brew update'; fi"

[tasks."update:apt"]
description = "APT ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°ï¼ˆUbuntu/Debian ç’°å¢ƒï¼‰"
run = "if command -v apt-get >/dev/null 2>&1 && [ -f /etc/debian_version ]; then sudo apt-get update && sudo apt-get upgrade -y; else echo 'APT not available, skipping apt update'; fi"

[tasks."update:external-repos"]
description = "å¤–éƒ¨ Git ãƒªãƒã‚¸ãƒˆãƒªã‚’æ›´æ–°ï¼ˆå¼·åˆ¶ãƒªã‚»ãƒƒãƒˆï¼‰"
run = [
  "if [ -d ~/src/github.com/brookhong/Surfingkeys ]; then cd ~/src/github.com/brookhong/Surfingkeys && git fetch origin && git reset --hard origin/master && git clean -fd; else echo 'Skip: ~/src/github.com/brookhong/Surfingkeys not found'; fi",
]

# ========================================
# Home Manager ç®¡ç†
# ========================================
[tasks."hm:switch"]
description = "Home Manager ã‚’é©ç”¨ï¼ˆdotfilesé…å¸ƒï¼‰"
run = "home-manager switch --flake . --impure"

[tasks."hm:check"]
description = "Home Manager è¨­å®šã®æ¤œè¨¼ï¼ˆãƒ“ãƒ«ãƒ‰ã®ã¿ã€é©ç”¨ãªã—ï¼‰"
run = "home-manager build --flake . --impure"

[tasks."hm:generations"]
description = "Home Manager ã®ä¸–ä»£ä¸€è¦§ã‚’è¡¨ç¤º"
run = "home-manager generations"

[tasks."hm:rollback"]
description = "Home Manager ã‚’å‰ã®ä¸–ä»£ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯"
run = """
  # List generations and select the previous one
  prev_gen=$(home-manager generations | head -2 | tail -1 | awk '{print $NF}')
  if [ -z "$prev_gen" ]; then
    echo "âŒ No previous generation found"
    exit 1
  fi
  echo "ğŸ“¦ Rolling back to generation: $prev_gen"
  home-manager switch --flake . --impure --switch-generation "$prev_gen"
"""

[tasks."hm:clean"]
description = "å¤ã„ Home Manager ä¸–ä»£ã‚’å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šå‰ï¼‰"
run = "home-manager expire-generations '-30 days'"

# CI/CD
[tasks.ci]
description = "ã™ã¹ã¦ã® CI ãƒã‚§ãƒƒã‚¯ã‚’ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼ˆGitHub Actions ã¨åŒã˜ï¼‰"
depends = ["format", "lint:docs", "lint:links", "test:lua"]

[tasks."ci:install"]
description = "CI ã«å¿…è¦ãªè¿½åŠ ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
run = """
luarocks install --local luacheck
luarocks install --local busted
"""

[tasks."ci:deploy"]
description = "CIç’°å¢ƒã§ãƒ•ã‚¡ã‚¤ãƒ«é…å¸ƒï¼ˆHome Managerï¼‰"
run = "nix run home-manager -- switch --flake . --impure -b backup"
