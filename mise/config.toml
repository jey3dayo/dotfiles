# ========================================
# グローバル mise 設定（ツール・共通設定のみ）
# ~/.config/mise/config.toml
# ========================================

[settings]
env_file = '.env'
experimental = true
jobs = 8  # デフォルトの並列実行数
vfox = false
idiomatic_version_file_enable_tools = ["go"]
trusted_config_paths = ["~/src/github.com", "/private/var/folders"]

[settings.pipx]
uvx = true

[env]
_.source = [".venv/bin/activate"]
YAMLLINT_CONFIG_FILE = "yamllint/config"
MD_GLOB = "**/*.md"
MD_EXCLUDES = "#node_modules #tmux/plugins #fisher #zsh/.zinit"

# ========================================
# オプション環境変数（ファイル限定処理）
# ========================================
# フォーマット/lint タスクで特定ファイルのみ処理する場合に設定
# 例: SH_FILES="script1.sh script2.sh" mise run format:shell
#
# SH_FILES = ""      # シェルスクリプト
# PY_FILES = ""      # Python ファイル
# LUA_FILES = ""     # Lua ファイル
# TOML_FILES = ""    # TOML ファイル
# BIOME_FILES = ""   # JS/TS/JSON ファイル (biome)
# PRETTIER_FILES = "" # Prettier 対象ファイル
# YAML_FILES = ""    # YAML ファイル

[tools]
actionlint = "latest"     # GitHub Actions workflow lint
biome = "latest"
fd = "latest"
go = "1.23.3"
node = "24"
python = "3.13.4"
"pipx:uv" = "latest"
"pipx:git+https://github.com/agentskills/agentskills.git" = "main#subdirectory=skills-ref"
prettier = "latest"
stylua = "latest"
shfmt = "latest"
shellcheck = "latest"
lua = "5.1.5"             # LuaRocks/Neovim require Lua 5.1
luajit = "latest"
yamllint = "latest"       # YAML lint
"npm:@bufbuild/protoc-gen-es" = "latest"
"npm:@connectrpc/protoc-gen-connect-es" = "latest"
"npm:@fsouza/prettierd" = "latest"
"npm:@openai/codex" = "latest"
"npm:aicommits" = "latest"
"npm:corepack" = "latest"
"npm:husky" = "latest"
"npm:markdown-link-check" = "latest"
"npm:markdownlint-cli2" = "latest"
"npm:neovim" = "latest"
"npm:npm" = "latest"
"npm:npm-check-updates" = "latest"
"npm:textlint" = "latest"
"npm:textlint-rule-preset-ja-technical-writing" = "latest"
taplo = "latest"

# ========================================
# Cargo-based tools (Rust CLI utilities)
# ========================================
# Usage: mise install to install all tools
# Syntax: "cargo:<crate-name>" = "version"
# Note: bat, ripgrep, fd, eza, hexyl, zoxide are managed by Homebrew (see Brewfile)
"cargo:needle-cli" = "latest"          # Semantic code search
"cargo:similarity-ts" = "latest"       # TypeScript/JavaScript code similarity analyzer
"cargo:wrkflw" = "latest"              # GitHub Actions workflow runner
"cargo:bandwhich" = "latest"           # Network bandwidth monitor

[tasks."format:biome"]
description = "JS/TS/JSON ファイルをフォーマット（BIOME_FILES で対象を限定可能）"
run = """
if [ -n "${BIOME_FILES:-}" ]; then
  biome format --write ${BIOME_FILES}
else
  biome format --write .
fi
"""

[tasks."format:biome:check"]
description = "JS/TS/JSON ファイルのフォーマットチェック（書き込みなし、BIOME_FILES で対象を限定可能）"
run = """
if [ -n "${BIOME_FILES:-}" ]; then
  biome check --formatter-enabled=true --linter-enabled=false ${BIOME_FILES}
else
  biome check --formatter-enabled=true --linter-enabled=false .
fi
"""

[tasks."format:prettier"]
description = "Prettier でファイルをフォーマット（PRETTIER_FILES で対象を限定可能）"
run = """
if [ -n "${PRETTIER_FILES:-}" ]; then
  prettier --write --ignore-unknown ${PRETTIER_FILES}
else
  prettier --write --ignore-unknown .
fi
"""

[tasks."format:prettier:check"]
description = "Prettier フォーマットチェック（書き込みなし、PRETTIER_FILES で対象を限定可能）"
run = """
if [ -n "${PRETTIER_FILES:-}" ]; then
  prettier --check --ignore-unknown ${PRETTIER_FILES}
else
  prettier --check --ignore-unknown .
fi
"""

[tasks."format:markdown"]
description = "Markdown ファイルをフォーマット"
run = [
  "markdownlint-cli2 --fix \"${MD_GLOB}\" ${MD_EXCLUDES}",
  "fd -e md -X prettier --write",
]

[tasks."format:markdown:check"]
description = "Markdown ファイルのフォーマットチェック（書き込みなし）"
run = "fd -e md -X prettier --check"

[tasks."format:yaml"]
description = "YAML ファイルをフォーマット（YAML_FILES で対象を限定可能）"
run = """
if [ -n "${YAML_FILES:-}" ]; then
  prettier --write ${YAML_FILES}
else
  fd -e yml -e yaml -X prettier --write
fi
"""

[tasks."format:yaml:check"]
description = "YAML ファイルのフォーマットチェック（書き込みなし、YAML_FILES で対象を限定可能）"
run = """
if [ -n "${YAML_FILES:-}" ]; then
  prettier --check ${YAML_FILES}
else
  fd -e yml -e yaml -X prettier --check
fi
"""

[tasks."format:lua"]
description = "Lua ファイルをフォーマット（LUA_FILES で対象を限定可能）"
run = """
if [ -n "${LUA_FILES:-}" ]; then
  stylua ${LUA_FILES}
else
  stylua .
fi
"""

[tasks."format:lua:check"]
description = "Lua ファイルのフォーマットチェック（書き込みなし、LUA_FILES で対象を限定可能）"
run = """
if [ -n "${LUA_FILES:-}" ]; then
  stylua --check ${LUA_FILES}
else
  stylua --check .
fi
"""

[tasks."format:shell"]
description = "シェルスクリプトをフォーマット（SH_FILES で対象を限定可能）"
run = """
if [ -n "${SH_FILES:-}" ]; then
  shfmt -w -i 2 -ci -bn ${SH_FILES}
else
  fd -e sh -X shfmt -w -i 2 -ci -bn
fi
"""

[tasks."format:shell:check"]
description = "シェルスクリプトのフォーマットチェック（書き込みなし、SH_FILES で対象を限定可能）"
run = """
if [ -n "${SH_FILES:-}" ]; then
  shfmt -d -i 2 -ci -bn ${SH_FILES}
else
  fd -e sh -X shfmt -d -i 2 -ci -bn
fi
"""

[tasks."format:toml"]
description = "TOML ファイルをフォーマット（TOML_FILES で対象を限定可能）"
run = """
if [ -n "${TOML_FILES:-}" ]; then
  taplo format ${TOML_FILES}
else
  taplo format .
fi
"""

[tasks."format:toml:check"]
description = "TOML ファイルのフォーマットチェック（書き込みなし、TOML_FILES で対象を限定可能）"
run = """
if [ -n "${TOML_FILES:-}" ]; then
  taplo format --check ${TOML_FILES}
else
  taplo format --check .
fi
"""

[tasks."format:python"]
description = "Python ファイルをフォーマット（PY_FILES で対象を限定可能）"
run = """
if [ -n "${PY_FILES:-}" ]; then
  uvx ruff format ${PY_FILES}
else
  uvx ruff format .
fi
"""

[tasks."format:python:check"]
description = "Python フォーマットチェック（書き込みなし、PY_FILES で対象を限定可能）"
run = """
if [ -n "${PY_FILES:-}" ]; then
  uvx ruff format --check ${PY_FILES}
else
  uvx ruff format --check .
fi
"""

[tasks."format:docs"]
description = "ドキュメントの完全な検証とフォーマット"
depends = ["format:markdown", "lint:links", "lint:yaml"]

[tasks."lint:docs"]
description = "ドキュメント全体の検証（lint + リンク + YAML）"
depends = ["lint:markdown", "lint:links", "lint:yaml"]

[tasks."lint:biome"]
description = "JS/TS/JSON ファイルをチェック（BIOME_FILES で対象を限定可能）"
run = """
if [ -n "${BIOME_FILES:-}" ]; then
  biome check ${BIOME_FILES}
else
  biome check .
fi
"""

[tasks."lint:markdown"]
description = "Markdown ファイルをチェック"
run = [
  "markdownlint-cli2 \"${MD_GLOB}\" ${MD_EXCLUDES}",
  "fd -e md -X prettier --check",
]

[tasks."lint:toml"]
description = "TOML ファイルをチェック（TOML_FILES で対象を限定可能）"
run = """
if [ -n "${TOML_FILES:-}" ]; then
  taplo format --check ${TOML_FILES}
else
  taplo format --check .
fi
"""

[tasks."lint:yaml"]
description = "YAML ファイルをチェック（prettier + yamllint、YAML_FILES で対象を限定可能）"
run = """
if [ -n "${YAML_FILES:-}" ]; then
  prettier --check ${YAML_FILES}
  # yamllint は YAML_FILES 指定時も .github/ ディレクトリをチェック
  yamllint -f parsable .github/
else
  fd -e yml -e yaml -X prettier --check
  yamllint -f parsable .github/
fi
"""

[tasks."lint:python"]
description = "Python ファイルをチェック（PY_FILES で対象を限定可能）"
run = """
if [ -n "${PY_FILES:-}" ]; then
  uvx ruff check ${PY_FILES}
else
  uvx ruff check .
fi
"""

[tasks."lint:shell"]
description = "シェルスクリプト (.sh/.zsh) をチェック（SH_FILES で対象を限定可能）"
run = """
if [ -n "${SH_FILES:-}" ]; then
  shfmt -d -i 2 -ci -bn ${SH_FILES}
  shellcheck ${SH_FILES}
else
  fd -e sh -X shfmt -d -i 2 -ci -bn
  fd -e sh -X shellcheck
  fd --hidden -e zsh -X zsh -n
fi
"""

[tasks."lint:dockerfile"]
description = "Dockerfile をチェック（hadolint、--no-color オプション付き）"
run = """
if [ -n "${DOCKERFILE_FILES:-}" ]; then
  hadolint --no-color ${DOCKERFILE_FILES}
else
  fd -t f -e dockerfile -X hadolint --no-color
  fd -t f --glob 'Dockerfile*' -X hadolint --no-color
fi
"""

[tasks."lint:links"]
description = "Markdown リンクチェック（時間がかかるため個別実行推奨）"
run = "fd -e md -x markdown-link-check --config .markdown-link-check.json -q"

[tasks."lint:links:verbose"]
description = "Markdown リンクチェック（詳細モード）"
run = "fd -e md -x markdown-link-check --config .markdown-link-check.json --verbose"

[tasks."lint:lua"]
description = "Lua ファイルをチェック"
depends = ["lint:lua:stylua", "lint:lua:luacheck"]

[tasks."lint:lua:stylua"]
description = "Stylua でコードスタイルをチェック（LUA_FILES で対象を限定可能）"
run = """
if [ -n "${LUA_FILES:-}" ]; then
  stylua --check ${LUA_FILES}
else
  stylua --check .
fi
"""

[tasks."lint:lua:luacheck"]
description = "luacheck を実行（利用可能な場合）"
run = "if command -v luacheck >/dev/null 2>&1; then luacheck .; fi"
