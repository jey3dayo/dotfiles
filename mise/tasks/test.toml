# ========================================
# Test Tasks
# ========================================
# テスト実行タスク

["test"]
description = "テストを実行（集約）"
depends = ["test:lua", "test:ts"]

["test:ts"]
description = "TypeScript スクリプトのユニットテストを実行"
run = "tsx --test agents/scripts/skills-add/utils.test.ts"

["test:lua"]
description = "Lua テストを実行(busted)"
run = """
# Add ~/.luarocks/bin to PATH if not already present
export PATH="${HOME}/.luarocks/bin:${PATH}"

# Check if busted is installed
if ! command -v busted >/dev/null 2>&1; then
  echo "⚠️  busted not found. Installing via luarocks..."
  luarocks install --local busted
  if ! command -v busted >/dev/null 2>&1; then
    echo "❌ Failed to install busted. Please run: mise run ci:install"
    exit 1
  fi
fi

busted --verbose spec/ nvim/spec/
"""

["test:lua:watch"]
description = "Lua テストを監視モードで実行(ファイル変更時に自動再実行)"
run = """
export PATH="${HOME}/.luarocks/bin:${PATH}"
if command -v fswatch >/dev/null 2>&1; then
  echo "Watching spec/, nvim/spec/, and nvim/lua/ for changes..."
  fswatch -o spec/ nvim/spec/ nvim/lua/ wezterm/ | while read; do
    clear
    echo "=== Running tests at $(date) ==="
    busted --verbose spec/ nvim/spec/ || true
  done
else
  echo "⚠️  fswatch not installed. Install with: brew install fswatch"
  exit 1
fi
"""
