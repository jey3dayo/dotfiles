# ========================================
# Home Manager ç®¡ç†
# ========================================

["hm:switch"]
description = "Home Manager ã‚’é©ç”¨ï¼ˆdotfilesé…å¸ƒï¼‰"
run = """
if command -v home-manager >/dev/null 2>&1; then
  home-manager switch --flake . --impure
else
  if ! command -v nix >/dev/null 2>&1 && [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
  if ! command -v nix >/dev/null 2>&1; then
    echo "âŒ nix not found. Cannot run home-manager fallback." >&2
    exit 127
  fi
  nix run home-manager -- switch --flake . --impure
fi
"""

["hm:check"]
description = "Home Manager è¨­å®šã®æ¤œè¨¼ï¼ˆãƒ“ãƒ«ãƒ‰ã®ã¿ã€é©ç”¨ãªã—ï¼‰"
run = """
if command -v home-manager >/dev/null 2>&1; then
  home-manager build --flake . --impure
else
  if ! command -v nix >/dev/null 2>&1 && [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
  if ! command -v nix >/dev/null 2>&1; then
    echo "âŒ nix not found. Cannot run home-manager fallback." >&2
    exit 127
  fi
  nix run home-manager -- build --flake . --impure
fi
"""

["hm:generations"]
description = "Home Manager ã®ä¸–ä»£ä¸€è¦§ã‚’è¡¨ç¤º"
run = """
if command -v home-manager >/dev/null 2>&1; then
  home-manager generations
else
  if ! command -v nix >/dev/null 2>&1 && [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
  if ! command -v nix >/dev/null 2>&1; then
    echo "âŒ nix not found. Cannot run home-manager fallback." >&2
    exit 127
  fi
  nix run home-manager -- generations
fi
"""

["hm:news"]
description = "Home Manager ã® news ã‚’è¡¨ç¤ºï¼ˆflakeç”¨ï¼‰"
run = """
if command -v home-manager >/dev/null 2>&1; then
  home-manager news --flake . --impure
else
  if ! command -v nix >/dev/null 2>&1 && [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
  if ! command -v nix >/dev/null 2>&1; then
    echo "âŒ nix not found. Cannot run home-manager fallback." >&2
    exit 127
  fi
  nix run home-manager -- news --flake . --impure
fi
"""

["hm:rollback"]
description = "Home Manager ã‚’å‰ã®ä¸–ä»£ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯"
run = """
run_hm() {
  if command -v home-manager >/dev/null 2>&1; then
    home-manager "$@"
    return
  fi

  if ! command -v nix >/dev/null 2>&1 && [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi

  if ! command -v nix >/dev/null 2>&1; then
    echo "âŒ nix not found. Cannot run home-manager fallback." >&2
    return 127
  fi

  nix run home-manager -- "$@"
}

generations_output="$(run_hm generations)"
if [ "$?" -ne 0 ]; then
  exit "$?"
fi

prev_gen="$(printf "%s\n" "$generations_output" | awk 'NR==2 { print $NF; exit }')"
if [ -z "$prev_gen" ]; then
  echo "âŒ No previous generation found"
  exit 1
fi

echo "ðŸ“¦ Rolling back to generation: $prev_gen"
run_hm switch --flake . --impure --switch-generation "$prev_gen"
"""

["hm:clean"]
description = "å¤ã„ Home Manager ä¸–ä»£ã‚’å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šå‰ï¼‰"
run = """
if command -v home-manager >/dev/null 2>&1; then
  home-manager expire-generations '-30 days'
else
  if ! command -v nix >/dev/null 2>&1 && [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
  if ! command -v nix >/dev/null 2>&1; then
    echo "âŒ nix not found. Cannot run home-manager fallback." >&2
    exit 127
  fi
  nix run home-manager -- expire-generations '-30 days'
fi
"""

["hm:deploy"]
description = "Home Manager ã‚’é©ç”¨ï¼ˆCI/è‡ªå‹•åŒ–ç”¨ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãï¼‰"
run = """
if command -v home-manager >/dev/null 2>&1; then
  home-manager switch --flake . --impure -b backup
else
  if ! command -v nix >/dev/null 2>&1 && [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
  if ! command -v nix >/dev/null 2>&1; then
    echo "âŒ nix not found. Cannot run home-manager fallback." >&2
    exit 127
  fi
  nix run home-manager -- switch --flake . --impure -b backup
fi
"""
