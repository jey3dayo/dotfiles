# ========================================
# Home Manager ç®¡ç†
# ========================================

["hm:switch"]
description = "Home Manager ã‚’é©ç”¨ï¼ˆdotfilesé…å¸ƒï¼‰"
run = """
. "./mise/tasks/lib/home-manager.sh"
run_hm switch --flake . --impure
"""

["hm:check"]
description = "Home Manager è¨­å®šã®æ¤œè¨¼ï¼ˆãƒ“ãƒ«ãƒ‰ã®ã¿ã€é©ç”¨ãªã—ï¼‰"
run = """
. "./mise/tasks/lib/home-manager.sh"
run_hm build --flake . --impure
"""

["hm:generations"]
description = "Home Manager ã®ä¸–ä»£ä¸€è¦§ã‚’è¡¨ç¤º"
run = """
. "./mise/tasks/lib/home-manager.sh"
run_hm generations
"""

["hm:news"]
description = "Home Manager ã® news ã‚’è¡¨ç¤ºï¼ˆflakeç”¨ï¼‰"
run = """
. "./mise/tasks/lib/home-manager.sh"
run_hm news --flake . --impure
"""

["hm:rollback"]
description = "Home Manager ã‚’å‰ã®ä¸–ä»£ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯"
run = """
. "./mise/tasks/lib/home-manager.sh"

generations_output="$(run_hm generations)"
status="$?"
if [ "$status" -ne 0 ]; then
  exit "$status"
fi

prev_gen="$(printf "%s\n" "$generations_output" | awk 'NR==2 { print $NF; exit }')"
if [ -z "$prev_gen" ]; then
  echo "âŒ No previous generation found"
  exit 1
fi

echo "ğŸ“¦ Rolling back to generation: $prev_gen"
run_hm switch --flake . --impure --switch-generation "$prev_gen"
"""

["hm:clean"]
description = "å¤ã„ Home Manager ä¸–ä»£ã‚’å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šå‰ï¼‰"
run = """
. "./mise/tasks/lib/home-manager.sh"
run_hm expire-generations '-30 days'
"""

["hm:deploy"]
description = "Home Manager ã‚’é©ç”¨ï¼ˆCI/è‡ªå‹•åŒ–ç”¨ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãï¼‰"
run = """
. "./mise/tasks/lib/home-manager.sh"
run_hm switch --flake . --impure -b backup
"""
