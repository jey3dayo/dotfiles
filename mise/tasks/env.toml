# ========================================
# Environment Variable Management (dotenvx)
# ========================================

["setup-env"]
description = ".env を .env.local に復号化（mise hooks から自動実行）"
run = "scripts/setup-env.sh"

["env:encrypt"]
description = "環境変数ファイルを暗号化"
run = "dotenvx encrypt -f ${XDG_CONFIG_HOME:-$HOME/.config}/.env"

["env:decrypt"]
description = "環境変数ファイルを復号化"
run = "DOTENV_PRIVATE_KEY_PATH=${XDG_CONFIG_HOME:-$HOME/.config}/.env.keys dotenvx decrypt -f ${XDG_CONFIG_HOME:-$HOME/.config}/.env"

["env:detect"]
description = "現在の環境タイプを検出（CI/Pi/Default）"
run = '''
  #!/bin/bash
  set -e

  # Colors
  BLUE='\033[0;34m'
  GREEN='\033[0;32m'
  YELLOW='\033[1;33m'
  BOLD='\033[1m'
  NC='\033[0m' # No Color

  CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"

  printf "\n"
  printf "%b\n" "${BOLD}${BLUE}========================================${NC}"
  printf "%b\n" "${BOLD}${BLUE}  Environment Detection${NC}"
  printf "%b\n" "${BOLD}${BLUE}========================================${NC}"
  printf "\n"

  # Environment variables check
  printf "%b\n" "${BOLD}Environment Variables:${NC}"
  printf "  CI: %s\n" "${CI:-not set}"
  printf "  GITHUB_ACTIONS: %s\n" "${GITHUB_ACTIONS:-not set}"
  printf "  MISE_CONFIG_FILE: %s\n" "${MISE_CONFIG_FILE:-not set}"
  printf "\n"

  # System information
  printf "%b\n" "${BOLD}System Information:${NC}"
  printf "  Architecture: %s\n" "$(uname -m)"
  printf "  OS: %s\n" "$(uname -s)"
  if [ -f /proc/cpuinfo ]; then
    CPUINFO_MODEL=$(grep -m 1 "Model" /proc/cpuinfo 2>/dev/null || echo "N/A")
    CPUINFO_HARDWARE=$(grep -m 1 "Hardware" /proc/cpuinfo 2>/dev/null || echo "N/A")
    printf "  CPU Model: %s\n" "$CPUINFO_MODEL"
    printf "  Hardware: %s\n" "$CPUINFO_HARDWARE"
  else
    printf "  /proc/cpuinfo: not available (non-Linux)\n"
  fi
  printf "\n"

  # Environment type detection (follows nix/env-detect.nix logic)
  ENV_TYPE="default"
  ENV_COLOR=$GREEN

  if [ "$CI" = "true" ] || [ "$GITHUB_ACTIONS" = "true" ]; then
    ENV_TYPE="ci"
    ENV_COLOR=$YELLOW
  elif [ -f /proc/cpuinfo ]; then
    ARCH=$(uname -m)
    if [[ "$ARCH" == "aarch64" || "$ARCH" == "armv7l" ]]; then
      if grep -qE "Raspberry Pi|BCM27[0-9][0-9]|BCM283[0-9]" /proc/cpuinfo 2>/dev/null; then
        ENV_TYPE="pi"
        ENV_COLOR=$BLUE
      fi
    fi
  fi

  # Detection result
  printf "%b\n" "${BOLD}Detected Environment:${NC}"
  printf "  %b%s%b\n" "${ENV_COLOR}${BOLD}" "$ENV_TYPE" "${NC}"
  printf "\n"

  # Expected mise config file
  EXPECTED_CONFIG="$CONFIG_HOME/mise/config.$ENV_TYPE.toml"
  printf "%b\n" "${BOLD}Mise Configuration:${NC}"
  printf "  Expected: %s\n" "$EXPECTED_CONFIG"
  if [ -f "$EXPECTED_CONFIG" ]; then
    printf "  %bStatus: ✓ File exists%b\n" "$GREEN" "$NC"
  else
    printf "  %bStatus: ✗ File not found%b\n" "$YELLOW" "$NC"
  fi
  printf "\n"

  # Detection explanation
  printf "%b\n" "${BOLD}Detection Logic (Priority: CI > Pi > Default):${NC}"
  printf "  1. CI: %s\n" "$([ "$CI" = "true" ] || [ "$GITHUB_ACTIONS" = "true" ] && echo "✓ Matched" || echo "✗ Not matched")"
  printf "  2. Raspberry Pi: %s\n" "$([ "$ENV_TYPE" = "pi" ] && echo "✓ Matched (ARM + Raspberry Pi markers)" || echo "✗ Not matched")"
  printf "  3. Default: %s\n" "$([ "$ENV_TYPE" = "default" ] && echo "✓ Fallback (WSL2/macOS/Linux)" || echo "○ Not used")"
  printf "\n"
'''
