# ========================================
# Lint Tasks
# ========================================
# コード品質チェックタスク（チェックのみ、修正なし）
# フォーマット判定は基本的に format:*:check へ集約
# 各タスクは環境変数で対象ファイルを限定可能

["lint:biome"]
description = "JS/TS/JSON ファイルをチェック（BIOME_FILES で対象を限定可能）"
run = """
if [ -n "${BIOME_FILES:-}" ]; then
  biome lint ${BIOME_FILES}
else
  biome lint .
fi
"""

["lint:markdown"]
description = "Markdown ファイルをチェック"
run = """
markdownlint-cli2 "${MD_GLOB}" ${MD_EXCLUDES}
"""

["lint:yaml"]
description = "YAML ファイルをチェック（yamllint、YAML_FILES で対象を限定可能）"
run = """
if [ -n "${YAML_FILES:-}" ]; then
  yamllint -f parsable ${YAML_FILES}
else
  fd -e yml -e yaml ${TASK_EXCLUDES} -X yamllint -f parsable
fi
"""

["lint:python"]
description = "Python ファイルをチェック（PY_FILES で対象を限定可能）"
run = """
if [ -n "${PY_FILES:-}" ]; then
  uvx ruff check ${PY_FILES}
else
  uvx ruff check ${TASK_EXCLUDES} .
fi
"""

["lint:shell"]
description = "シェルスクリプトをチェック（SH_FILES で対象を限定可能）"
run = """
if [ -n "${SH_FILES:-}" ]; then
  zsh_files=""
  shfmt_files=""
  for file in ${SH_FILES}; do
    case "$file" in
      *.zsh|zsh/bin/*)
        zsh_files="${zsh_files} ${file}"
        ;;
      *)
        shfmt_files="${shfmt_files} ${file}"
        ;;
    esac
  done

  if [ -n "${shfmt_files}" ]; then
    shfmt -d -i 2 -ci -bn ${shfmt_files}
    shellcheck ${shfmt_files}
  fi

  if [ -n "${zsh_files}" ] && command -v zsh >/dev/null 2>&1; then
    zsh -n ${zsh_files}
  elif [ -n "${zsh_files}" ]; then
    echo "⚠️ zsh not found; skipping zsh syntax check for:${zsh_files}"
  fi
else
  # scripts/ (some files have no extension)
  fd -t f -H -p '^scripts/' -X shfmt -d -i 2 -ci -bn
  fd -t f -H -p '^scripts/' -X shellcheck

  # Bash entrypoints
  bash -n bash/.bashrc bash/.bash_profile
  shellcheck bash/.bashrc bash/.bash_profile

  # .sh files elsewhere
  fd -e sh ${TASK_EXCLUDES} -X shfmt -d -i 2 -ci -bn
  fd -e sh ${TASK_EXCLUDES} -X shellcheck

  # zsh syntax check (.zsh + zsh/bin/*)
  if command -v zsh >/dev/null 2>&1; then
    fd --hidden -e zsh -X zsh -n
    fd -t f -H -p '^zsh/bin/' -X zsh -n
  else
    echo "⚠️ zsh not found; skipping zsh syntax checks"
  fi
fi
"""

["lint:dockerfile"]
description = "Dockerfile をチェック（hadolint、--no-color オプション付き）"
run = """
if [ -n "${DOCKERFILE_FILES:-}" ]; then
  hadolint --no-color ${DOCKERFILE_FILES}
else
  fd -t f -e dockerfile -X hadolint --no-color
  fd -t f --glob 'Dockerfile*' -X hadolint --no-color
fi
"""

["lint:links"]
description = "Markdown リンクチェック（時間がかかるため個別実行推奨）"
run = "fd -e md ${TASK_EXCLUDES} -x markdown-link-check --config ${MARKDOWN_LINK_CONFIG} -q"

["lint:lua"]
description = "Lua ファイルをチェック（luacheck）"
depends = ["lint:lua:luacheck"]

["lint:lua:luacheck"]
description = "luacheck を実行（必須）"
run = """
if ! command -v luacheck >/dev/null 2>&1; then
  echo "❌ luacheck not found. Run: mise run ci:install"
  exit 1
fi

if [ -n "${LUA_FILES:-}" ]; then
  luacheck -q ${LUA_FILES}
else
  fd --hidden -e lua ${TASK_EXCLUDES} -X luacheck -q
fi
"""
