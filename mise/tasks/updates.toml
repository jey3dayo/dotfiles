# ========================================
# 更新タスク（mac/local 依存）
# ========================================

["update"]
description = "すべての依存関係を更新"
depends = [
  "update:submodules",
  "update:brew",
  "update:apt",
  "update:external-repos",
]

["update:submodules"]
description = "Git サブモジュールを最新に更新（ローカル変更を破棄、ネストは固定コミットに同期）"
run = """
if [ ! -f .gitmodules ]; then
  echo "No submodules configured, skipping"
  exit 0
fi

git submodule sync --recursive
git submodule foreach --recursive "git reset --hard HEAD && git clean -fd"
# Update only top-level submodules to latest remote tip
GIT_HTTP_VERSION=HTTP/1.1 git -c http.version=HTTP/1.1 submodule update --remote
# Then align nested submodules to commits pinned by each parent submodule
git submodule update --init --recursive
"""

["update:brew"]
description = "Homebrew パッケージを更新（formula のみ、cask は除く）"
run = "if command -v brew >/dev/null 2>&1; then (brew update 2>&1 | grep -v \"definition is invalid\" || true) && brew upgrade --formula; else echo 'Homebrew not installed, skipping brew update'; fi"

["update:apt"]
description = "APT パッケージを更新（Ubuntu/Debian 環境）"
run = "if command -v apt-get >/dev/null 2>&1 && [ -f /etc/debian_version ]; then sudo apt-get update && sudo apt-get upgrade -y; else echo 'APT not available, skipping apt update'; fi"

["update:external-repos"]
description = "外部 Git リポジトリを更新（強制リセット）"
run = [
  "if [ -d ~/src/github.com/brookhong/Surfingkeys ]; then cd ~/src/github.com/brookhong/Surfingkeys && git fetch origin && git reset --hard origin/master && git clean -fd; else echo 'Skip: ~/src/github.com/brookhong/Surfingkeys not found'; fi",
]
