# ========================================
# Skills Tasks
# ========================================
# Agent skills 管理タスク

["skills:install"]
description = "HM でスキルをインストール"
run = "mise run hm:switch"

["skills:install:report"]
description = "インストール対象スキルのURLレポートを出力"
run = """
. "./mise/tasks/lib/home-manager.sh"
ensure_nix_or_fail "nix not found. Install Nix before running skills:install:report" || exit $?

nix run .#report
"""

["skills:report"]
description = "インストール対象スキルのURLレポートを出力"
run = """
. "./mise/tasks/lib/home-manager.sh"
ensure_nix_or_fail "nix not found. Install Nix before running skills:report" || exit $?

nix run .#report
"""

["skills:list"]
description = "有効スキル一覧を表示"
run = """
. "./mise/tasks/lib/home-manager.sh"
ensure_nix_or_fail "nix not found. Install Nix before running skills:list" || exit $?

nix run .#list
"""

["skills:add"]
description = "スキルを追加（例: mise run skills:add -- owner/repo や tree URL）"
run = "tsx ./agents/scripts/skills-add.ts"

["skills:validate"]
description = "スキル構成バリデーション"
run = """
if [ "${SKIP_NIX_VALIDATE:-0}" = "1" ]; then
  echo "Skip skills:validate (SKIP_NIX_VALIDATE=1)"
  exit 0
fi

. "./mise/tasks/lib/home-manager.sh"
ensure_nix_or_fail "nix not found. Install Nix or run with SKIP_NIX_VALIDATE=1" || exit $?

# Use temp cache for sandbox/readonly-home environments.
cache_root="${TMPDIR:-/tmp}/${USER:-user}/dotfiles-mise-cache"
mkdir -p "$cache_root"
XDG_CACHE_HOME="$cache_root" nix run .#validate
"""

["skills:validate:distribution"]
description = "distributions/default が SSoT ルールに準拠しているか検証"
run = "bash ./agents/scripts/validate-default-distribution.sh"

["skills:update"]
description = "全ソース更新（flake inputs）"
run = """
. "./mise/tasks/lib/home-manager.sh"
ensure_nix_or_fail "nix not found. Install Nix before running skills:update" || exit $?

nix flake update --flake .
"""

["skills:fix:bold-headings"]
description = "distributions/default/skills の太字見出しを ### へ変換"
run = "tsx ./agents/scripts/replace-bold-headings.ts"

["skills:check"]
description = "Skills配布検証（~/.claude/skills/ のカウントとリンク確認）"
run = '''
  #!/bin/bash
  set -e

  # Colors
  BLUE='\033[0;34m'
  GREEN='\033[0;32m'
  YELLOW='\033[1;33m'
  RED='\033[0;31m'
  BOLD='\033[1m'
  NC='\033[0m' # No Color

  SKILLS_DIR="$HOME/.claude/skills"
  EXPECTED_MIN_SKILLS=42  # skills-internal/ の最小数

  printf "\n"
  printf "%b\n" "${BOLD}${BLUE}========================================${NC}"
  printf "%b\n" "${BOLD}${BLUE}  Skills Distribution Check${NC}"
  printf "%b\n" "${BOLD}${BLUE}========================================${NC}"
  printf "\n"

  # Check if skills directory exists
  if [ ! -d "$SKILLS_DIR" ]; then
    printf "%b\n" "${RED}✗ Skills directory not found: $SKILLS_DIR${NC}"
    printf "\n"
    printf "%b\n" "${BOLD}Action Required:${NC}"
    printf "  Run: %bhome-manager switch --flake ~/.config --impure%b\n" "$YELLOW" "$NC"
    printf "\n"
    exit 1
  fi

  # Count skills (exclude .system, include both directories and symlinks)
  SKILLS_COUNT=$(find "$SKILLS_DIR" -mindepth 1 -maxdepth 1 ! -name ".system" 2>/dev/null | wc -l | tr -d ' ')
  printf "%b\n" "${BOLD}Skills Count:${NC}"
  printf "  Total: %d skills\n" "$SKILLS_COUNT"
  printf "  Expected: ≥ %d skills (internal)\n" "$EXPECTED_MIN_SKILLS"

  if [ "$SKILLS_COUNT" -lt "$EXPECTED_MIN_SKILLS" ]; then
    printf "  %bStatus: ✗ Insufficient skills (%d < %d)%b\n" "$RED$BOLD" "$SKILLS_COUNT" "$EXPECTED_MIN_SKILLS" "$NC"
    STATUS_FAILED=1
  else
    printf "  %bStatus: ✓ Sufficient skills (%d ≥ %d)%b\n" "$GREEN$BOLD" "$SKILLS_COUNT" "$EXPECTED_MIN_SKILLS" "$NC"
    STATUS_FAILED=0
  fi
  printf "\n"

  # Home Manager generation info
  printf "%b\n" "${BOLD}Home Manager Generation:${NC}"
  LATEST_GEN=$(home-manager generations 2>/dev/null | head -1 || echo "N/A")
  if [ "$LATEST_GEN" != "N/A" ]; then
    GEN_ID=$(echo "$LATEST_GEN" | awk '{print $1}')
    GEN_DATE=$(echo "$LATEST_GEN" | awk '{print $2, $3}')
    GEN_PATH=$(echo "$LATEST_GEN" | awk '{print $NF}')
    printf "  ID: %s\n" "$GEN_ID"
    printf "  Date: %s\n" "$GEN_DATE"
    printf "  Path: %s\n" "$GEN_PATH"

    # Check if generation includes agent-skills
    if [ -d "$GEN_PATH/home-files/.claude/skills" ]; then
      GEN_SKILLS_COUNT=$(find "$GEN_PATH/home-files/.claude/skills" -mindepth 1 -maxdepth 1 ! -name ".system" 2>/dev/null | wc -l | tr -d ' ')
      printf "  Skills in generation: %d\n" "$GEN_SKILLS_COUNT"
      if [ "$GEN_SKILLS_COUNT" -eq "$SKILLS_COUNT" ]; then
        printf "  %bGeneration match: ✓ Consistent%b\n" "$GREEN" "$NC"
      else
        printf "  %bGeneration match: ✗ Inconsistent (%d vs %d)%b\n" "$YELLOW" "$GEN_SKILLS_COUNT" "$SKILLS_COUNT" "$NC"
      fi
    else
      printf "  %bGeneration: ✗ No skills found in generation%b\n" "$RED" "$NC"
    fi
  else
    printf "  %bGeneration: ✗ Not available%b\n" "$RED" "$NC"
  fi
  printf "\n"

  # Symlink integrity check
  printf "%b\n" "${BOLD}Symlink Integrity:${NC}"
  BROKEN_LINKS=0
  VALID_LINKS=0

  for skill_dir in "$SKILLS_DIR"/*; do
    [ -e "$skill_dir" ] || continue
    skill_name=$(basename "$skill_dir")

    # Skip .system
    [ "$skill_name" = ".system" ] && continue

    if [ -L "$skill_dir" ]; then
      target=$(readlink "$skill_dir")
      if [ -d "$target" ]; then
        VALID_LINKS=$((VALID_LINKS + 1))
      else
        BROKEN_LINKS=$((BROKEN_LINKS + 1))
        printf "  %b✗ Broken: %s → %s%b\n" "$RED" "$skill_name" "$target" "$NC"
      fi
    else
      printf "  %b⚠ Not a symlink: %s%b\n" "$YELLOW" "$skill_name" "$NC"
    fi
  done

  printf "  Valid symlinks: %d\n" "$VALID_LINKS"
  printf "  Broken symlinks: %d\n" "$BROKEN_LINKS"

  if [ "$BROKEN_LINKS" -gt 0 ]; then
    printf "  %bStatus: ✗ Broken symlinks found%b\n" "$RED$BOLD" "$NC"
    STATUS_FAILED=1
  else
    printf "  %bStatus: ✓ All symlinks valid%b\n" "$GREEN$BOLD" "$NC"
  fi
  printf "\n"

  # Summary
  printf "%b\n" "${BOLD}Summary:${NC}"
  if [ "$STATUS_FAILED" -eq 1 ]; then
    printf "  %b✗ Skills distribution check FAILED%b\n" "$RED$BOLD" "$NC"
    printf "\n"
    printf "%b\n" "${BOLD}Troubleshooting:${NC}"
    printf "  1. Check if Home Manager was applied correctly:\n"
    printf "     %bhome-manager switch --flake ~/.config --impure%b\n" "$YELLOW" "$NC"
    printf "\n"
    printf "  2. Verify skills configuration:\n"
    printf "     %bmise run skills:list%b\n" "$YELLOW" "$NC"
    printf "\n"
    printf "  3. Check for conflicts with other Home Manager configurations:\n"
    printf "     %bhome-manager generations | head -3%b\n" "$YELLOW" "$NC"
    printf "\n"
    printf "  4. See troubleshooting guide:\n"
    printf "     %bcat ~/.config/.claude/rules/troubleshooting.md%b\n" "$YELLOW" "$NC"
    printf "\n"
    exit 1
  else
    printf "  %b✓ Skills distribution check PASSED%b\n" "$GREEN$BOLD" "$NC"
    printf "\n"
  fi
'''
