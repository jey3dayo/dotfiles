# ========================================
# Skills Tasks
# ========================================
# Agent skills 管理タスク

["skills:install"]
description = "HM でスキルをインストール"
run = "mise run hm:switch"

["skills:install:report"]
description = "インストール対象スキルのURLレポートを出力"
run = """
if ! command -v nix >/dev/null 2>&1; then
  # Load Nix env when installed via Determinate/Nix daemon (common on Linux)
  if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
fi

if ! command -v nix >/dev/null 2>&1; then
  echo "❌ nix not found. Install Nix before running skills:install:report" >&2
  exit 127
fi

nix run .#report
"""

["skills:report"]
description = "インストール対象スキルのURLレポートを出力"
run = """
if ! command -v nix >/dev/null 2>&1; then
  if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
fi

if ! command -v nix >/dev/null 2>&1; then
  echo "❌ nix not found. Install Nix before running skills:report" >&2
  exit 127
fi

nix run .#report
"""

["skills:list"]
description = "有効スキル一覧を表示"
run = """
if ! command -v nix >/dev/null 2>&1; then
  if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
fi

if ! command -v nix >/dev/null 2>&1; then
  echo "❌ nix not found. Install Nix before running skills:list" >&2
  exit 127
fi

nix run .#list
"""

["skills:add"]
description = "スキルを追加（例: mise run skills:add -- owner/repo や tree URL）"
run = "tsx ./agents/scripts/skills-add.ts"

["skills:validate"]
description = "スキル構成バリデーション"
run = """
if [ "${SKIP_NIX_VALIDATE:-0}" = "1" ]; then
  echo "Skip skills:validate (SKIP_NIX_VALIDATE=1)"
  exit 0
fi

if ! command -v nix >/dev/null 2>&1; then
  if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
fi

if ! command -v nix >/dev/null 2>&1; then
  echo "❌ nix not found. Install Nix or run with SKIP_NIX_VALIDATE=1" >&2
  exit 127
fi

# Use temp cache for sandbox/readonly-home environments.
cache_root="${TMPDIR:-/tmp}/${USER:-user}/dotfiles-mise-cache"
mkdir -p "$cache_root"
XDG_CACHE_HOME="$cache_root" nix run .#validate
"""

["skills:validate:distribution"]
description = "distributions/default が SSoT ルールに準拠しているか検証"
run = "bash ./agents/scripts/validate-default-distribution.sh"

["skills:update"]
description = "全ソース更新（flake inputs）"
run = """
if ! command -v nix >/dev/null 2>&1; then
  if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
fi

if ! command -v nix >/dev/null 2>&1; then
  echo "❌ nix not found. Install Nix before running skills:update" >&2
  exit 127
fi

nix flake update --flake .
"""

["skills:fix:bold-headings"]
description = "distributions/default/skills の太字見出しを ### へ変換"
run = "tsx ./agents/scripts/replace-bold-headings.ts"
