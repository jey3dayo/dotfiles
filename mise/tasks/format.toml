# ========================================
# Format Tasks
# ========================================
# フォーマッター実行タスク（自動修正）
# 各タスクは環境変数で対象ファイルを限定可能

["format:biome"]
description = "JS/TS/JSON ファイルをフォーマット + Biome lint の安全な自動修正（BIOME_FILES で対象を限定可能）"
run = """
if [ -n "${BIOME_FILES:-}" ]; then
  biome format --write ${BIOME_FILES}
  biome lint --write ${BIOME_FILES}
else
  biome format --write .
  biome lint --write .
fi
"""

["format:biome:check"]
description = "JS/TS/JSON ファイルのフォーマット + lint チェック（書き込みなし、BIOME_FILES で対象を限定可能）"
run = """
if [ -n "${BIOME_FILES:-}" ]; then
  biome check --formatter-enabled=true --linter-enabled=true ${BIOME_FILES}
else
  biome check --formatter-enabled=true --linter-enabled=true .
fi
"""

["format:prettier"]
description = "Prettier でファイルをフォーマット（PRETTIER_FILES で対象を限定可能）"
run = """
if [ -n "${PRETTIER_FILES:-}" ]; then
  prettier --write --ignore-unknown --log-level error ${PRETTIER_FILES} > /dev/null
else
  prettier --write --ignore-unknown --log-level error . > /dev/null
fi
"""

["format:prettier:check"]
description = "Prettier フォーマットチェック（書き込みなし、PRETTIER_FILES で対象を限定可能）"
run = """
if [ -n "${PRETTIER_FILES:-}" ]; then
  prettier --check --ignore-unknown --log-level error ${PRETTIER_FILES}
else
  prettier --check --ignore-unknown --log-level error .
fi
"""

["format:markdown"]
description = "Markdown ファイルをフォーマット"
depends = ["format:markdown:bold-headings", "format:markdownlint"]

["format:markdownlint"]
description = "Markdownlint + Prettier で Markdown をフォーマット"
run = [
  "markdownlint-cli2 --fix \"${MD_GLOB}\" ${MD_EXCLUDES}",
  "fd -H -e md ${TASK_EXCLUDES} -X prettier --write --log-level error >/dev/null",
]

["format:markdown:check"]
description = "Markdown ファイルのフォーマットチェック（書き込みなし）"
depends = ["format:markdown:bold-headings:check", "format:markdownlint:check"]

["format:markdownlint:check"]
description = "Markdownlint + Prettier の Markdown チェック（書き込みなし）"
run = "fd -H -e md ${TASK_EXCLUDES} -X prettier --check"

["format:yaml"]
description = "YAML ファイルをフォーマット（YAML_FILES で対象を限定可能）"
run = """
if [ -n "${YAML_FILES:-}" ]; then
  prettier --write --log-level error ${YAML_FILES} > /dev/null
else
  fd -e yml -e yaml -X prettier --write --log-level error >/dev/null
fi
"""

["format:yaml:check"]
description = "YAML ファイルのフォーマットチェック（書き込みなし、YAML_FILES で対象を限定可能）"
run = """
if [ -n "${YAML_FILES:-}" ]; then
  prettier --check --log-level error ${YAML_FILES}
else
  fd -e yml -e yaml -X prettier --check --log-level error
fi
"""

["format:lua"]
description = "Lua ファイルをフォーマット（LUA_FILES で対象を限定可能）"
run = """
if [ -n "${LUA_FILES:-}" ]; then
  stylua ${LUA_FILES}
else
  fd --hidden -e lua ${TASK_EXCLUDES} -X stylua
fi
"""

["format:lua:check"]
description = "Lua ファイルのフォーマットチェック（書き込みなし、LUA_FILES で対象を限定可能）"
run = """
if [ -n "${LUA_FILES:-}" ]; then
  stylua --check ${LUA_FILES}
else
  fd --hidden -e lua ${TASK_EXCLUDES} -X stylua --check
fi
"""

["format:shell"]
description = "シェルスクリプトをフォーマット（.sh は shfmt、.zsh は beautysh）"
run = """
if [ -n "${SH_FILES:-}" ]; then
  zsh_files=""
  shfmt_files=""
  for file in ${SH_FILES}; do
    case "$file" in
      *.zsh)
        zsh_files="${zsh_files} ${file}"
        ;;
      *)
        shfmt_files="${shfmt_files} ${file}"
        ;;
    esac
  done

  if [ -n "${shfmt_files}" ]; then
    shfmt -w -i 2 -ci -bn ${shfmt_files}
  fi

  if [ -n "${zsh_files}" ]; then
    beautysh -i 2 ${zsh_files}
  fi
else
  # scripts/ (some files have no extension)
  fd -t f -H -p '^scripts/' -X shfmt -w -i 2 -ci -bn
  # .sh files elsewhere
  fd -e sh ${TASK_EXCLUDES} -X shfmt -w -i 2 -ci -bn

  # .zsh files
  fd -e zsh ${TASK_EXCLUDES} -X beautysh -i 2
  fd -t f -H -p '^zsh/bin/' -X beautysh -i 2
fi
"""

["format:shell:check"]
description = "シェルスクリプトのフォーマットチェック（.sh は shfmt、.zsh は beautysh）"
run = """
if [ -n "${SH_FILES:-}" ]; then
  zsh_files=""
  shfmt_files=""
  for file in ${SH_FILES}; do
    case "$file" in
      *.zsh)
        zsh_files="${zsh_files} ${file}"
        ;;
      *)
        shfmt_files="${shfmt_files} ${file}"
        ;;
    esac
  done

  if [ -n "${shfmt_files}" ]; then
    shfmt -d -i 2 -ci -bn ${shfmt_files}
  fi

  if [ -n "${zsh_files}" ]; then
    beautysh -i 2 -c ${zsh_files}
  fi
else
  # scripts/ (some files have no extension)
  fd -t f -H -p '^scripts/' -X shfmt -d -i 2 -ci -bn
  # .sh files elsewhere
  fd -e sh ${TASK_EXCLUDES} -X shfmt -d -i 2 -ci -bn

  # .zsh files
  fd -e zsh ${TASK_EXCLUDES} -X beautysh -i 2 -c
  fd -t f -H -p '^zsh/bin/' -X beautysh -i 2 -c
fi
"""

["format:toml"]
description = "TOML ファイルをフォーマット（TOML_FILES で対象を限定可能）"
run = """
if [ -n "${TOML_FILES:-}" ]; then
  RUST_LOG=taplo=warn taplo format ${TOML_FILES}
else
  fd -e toml ${TASK_EXCLUDES} -X env RUST_LOG=taplo=warn taplo format
fi
"""

["format:toml:check"]
description = "TOML ファイルのフォーマットチェック（書き込みなし、TOML_FILES で対象を限定可能）"
run = """
if [ -n "${TOML_FILES:-}" ]; then
  RUST_LOG=taplo=warn taplo format --check ${TOML_FILES}
else
  fd -e toml ${TASK_EXCLUDES} -X env RUST_LOG=taplo=warn taplo format --check
fi
"""

["format:python"]
description = "Python ファイルをフォーマット（PY_FILES で対象を限定可能）"
run = """
if [ -n "${PY_FILES:-}" ]; then
  uvx ruff format ${PY_FILES}
else
  uvx ruff format ${TASK_EXCLUDES} .
fi
"""

["format:python:check"]
description = "Python フォーマットチェック（書き込みなし、PY_FILES で対象を限定可能）"
run = """
if [ -n "${PY_FILES:-}" ]; then
  uvx ruff format --check ${PY_FILES}
else
  uvx ruff format --check ${TASK_EXCLUDES} .
fi
"""

["format:docs"]
description = "ドキュメントの完全な検証とフォーマット"
depends = ["format:markdown", "format:yaml:check", "lint:yaml", "lint:links"]

["format:markdown:bold-headings"]
description = "Markdown ファイルの太字見出しを ### へ変換（引数でディレクトリ指定可能、デフォルト: リポジトリ全体）"
run = "tsx ./scripts/replace-bold-headings.ts"

["format:markdown:bold-headings:check"]
description = "Markdown ファイルの太字見出しチェック（変更なし）"
run = "tsx ./scripts/replace-bold-headings.ts --dry-run"
