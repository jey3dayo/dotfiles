# Rules System リファレンス

Claude Code のルールシステムの仕組みと設計指針。

## ロード順序と優先度

Claude Code は 2 箇所から rules（`.md` ファイル）を読み込む。

| レベル        | パス                   | スコープ           | 優先度                     |
| ------------- | ---------------------- | ------------------ | -------------------------- |
| User-level    | `~/.claude/rules/*.md` | 全プロジェクト共通 | 低（先に読み込み）         |
| Project-level | `.claude/rules/*.md`   | プロジェクト固有   | 高（後に読み込み、上書き） |

- Project-level が User-level を上書きする（同名ファイル・同トピックの場合）
- サブディレクトリは再帰的に探索される（例: `rules/frontend/react.md`）
- シンボリックリンク対応: 共有ルールを symlink で参照可能

## `paths` Frontmatter

ルールを特定のファイルパターンに限定する唯一の公式 frontmatter。

### YAML 配列形式（公式）

```yaml
---
paths:
  - "src/**/*.ts"
  - "lib/**/*.ts"
  - "tests/**/*.test.ts"
---
```

### glob パターン

| パターン     | 説明                       | 例                  |
| ------------ | -------------------------- | ------------------- |
| `**`         | 任意の深さのディレクトリ   | `src/**/*.ts`       |
| `*`          | 任意のファイル名           | `*.md`              |
| `{a,b}`      | ブレース展開で複数パターン | `{src,lib}/**/*.ts` |
| `*.{ts,tsx}` | 複数拡張子                 | `src/**/*.{ts,tsx}` |

### 省略時の挙動

`paths` を省略すると、ルールは全ファイルに無条件適用される。

### 注意

- `paths` 以外のキー（`source`, `references` 等）を frontmatter に書いても Claude Code は特別扱いしない
- 参照元や根拠を残したい場合は本文に記載する

## ルール構造のベストプラクティス

効果的なルールは以下の要素を含む:

```
制約   → 何を要求/禁止するか（明確で曖昧さがない）
根拠   → なぜこのルールが存在するか
例     → 正しい/不正なコード例
例外   → 許容されるケース（あれば）
強制   → どう検証するか（lint, CI, レビュー等）
```

### 最小構造

```markdown
---
paths:
  - "src/**/*.ts"
---

# ルール名

## 制約

[要求/禁止の明確な記述]

## 根拠

[技術的/ビジネス的正当性]

## 例

### 正しい

[コード例]

### 不正

[コード例]
```

## ディレクトリ構成例

```
.claude/rules/
├── frontend/
│   ├── react.md
│   └── styles.md
├── backend/
│   ├── api.md
│   └── database.md
├── testing.md
└── general.md
```

### ファイル命名

- kebab-case: `rule-name.md`
- 名前がルールの内容を反映するようにする
- サブディレクトリでカテゴリ分け

## アンチパターン

避けるべきこと:

- 曖昧な制約（「適切にバリデーションする」→ 「Zod スキーマで入力検証必須」）
- 根拠のないルール（なぜ必要かが不明）
- 強制手段のないルール（守られない）
- 既存ルールとの矛盾
- ガイドラインとの不要な重複

## ルールの競合解決

1. Project-level が User-level を上書き
2. 明示的なルールがガイドラインを上書き
3. 矛盾が解決できない場合はユーザーにエスカレート

## 関連リソース

- `resources/templates/rule-template.md` - ルールテンプレート
- `resources/examples/` - 実例
- `resources/checklist.md` - 品質チェックリスト
