---
description: Comprehensive code review with project-specific optimization
argument-hint: "[--simple] [--staged|--recent|--branch <name>] [--with-impact] [--fix] [--fix-pr [pr-number]]"
---

# Review - 統合コードレビューコマンド

包括的なコードレビューを実行するコマンドです。`code-review`スキルを呼び出し、プロジェクトに最適化されたレビューを提供します。

## ⚠️ 重要な注意事項

### GitHub連携について

- このコマンドはローカルでのレビューのみを実行します
- GitHub PRへのコメント投稿機能はありません
- レビュー結果はローカルに表示されます
- **すべてのレビュー結果は日本語で出力されます**

### 署名なしポリシー

**IMPORTANT**: すべての出力において以下を厳守：

- ❌ **NEVER** "Co-authored-by: Claude" をcommitに含めない
- ❌ **NEVER** "Generated with Claude Code" を含めない
- ❌ **NEVER** 絵文字をcommits、PRs、issuesに使用しない
- ❌ **NEVER** AI署名やウォーターマークを含めない

## 実行モード

このコマンドは2つのモードを提供します：

### 1. 詳細モード（デフォルト）

包括的な品質評価を実施：

- ⭐️ 5段階評価体系による次元別評価
- プロジェクトタイプ自動検出
- 技術スタック別スキル統合（typescript, react, golang, security, etc.）
- 詳細な改善提案とアクションプラン

**使用例**:

```bash
/review                    # 基本レビュー
/review --with-impact      # 影響分析を含む
/review --fix              # 自動修正を含む
```

### 2. シンプルモード

迅速な問題発見に特化：

- サブエージェント並列実行（security, performance, quality, architecture）
- 優先度付きの問題リスト
- 即座の修正提案
- GitHub issue連携オプション

**使用例**:

```bash
/review --simple           # クイックレビュー
/review --simple --fix     # レビュー + 自動修正
```

## 使用方法

### 基本的な使用

```bash
# 詳細モード（デフォルト）
/review

# シンプルモード
/review --simple
```

### 対象ファイル指定

レビュー対象は自動的に以下の優先順位で決定されます：

1. ステージされた変更（`git diff --cached`）
2. 直前のコミット（`git diff HEAD~1`）
3. 開発ブランチとの差分（`git diff origin/develop`など）
4. 最近変更されたファイル

**明示的指定**:

```bash
/review --staged           # ステージされた変更のみ
/review --recent           # 直前のコミット
/review --branch develop   # 指定ブランチとの差分
```

### Serena統合（詳細モード）

セマンティック解析機能を追加：

```bash
/review --with-impact      # API変更の影響範囲分析
/review --deep-analysis    # シンボルレベルの詳細解析
/review --verify-spec      # 仕様との整合性確認
```

### ワークフロー統合

```bash
/review --fix              # レビュー + 自動修正
/review --create-issues    # レビュー + GitHub issue作成
/review --learn            # レビュー + 学習データ記録
```

### 3. PRレビュー修正モード

GitHub PRのレビューコメントを自動修正：

- `gh-fix-review`スキル統合
- 優先度別コメント分類（Critical/High/Major/Minor）
- 自動修正と品質保証
- トラッキングドキュメント生成

**使用例**:

```bash
/review --fix-pr           # 現在のブランチのPR修正
/review --fix-pr 123       # PR番号指定
/review --fix-pr --priority critical  # Critical問題のみ修正
/review --fix-pr --dry-run # ドライラン（修正なし）
```

## 実装詳細

このコマンドは `code-review` スキルを呼び出し、以下のフローで動作します。

### 1. モード判定

コマンドライン引数から動作モードを決定：

- `--fix-pr` が指定 → **PRレビュー修正モード**
- `--simple` が指定 → **シンプルモード**（並列エージェント実行）
- その他 → **詳細モード**（⭐️ 5段階評価）

Serenaオプション（`--with-impact`, `--deep-analysis`, `--verify-spec`）が指定されている場合、セマンティック解析が有効化されます。

### 2. チェックポイント作成

レビュー前の状態を保存：

```bash
git add -A
git commit -m "Pre-review checkpoint" || echo "No changes to commit"
```

これにより、レビュー結果に基づく変更を安全にロールバックできます。

### 3. レビュー実行

#### 詳細モードの場合

1. **プロジェクト検出**: TypeScript、React、Go等の技術スタックを自動判定
2. **スキル統合**: 検出された技術に応じて専門スキルを自動統合
   - TypeScript → 型安全性チェック
   - React → Hooksとパフォーマンス
   - Go → イディオム、並行性
   - Security → 入力検証、認証・認可
3. **包括的評価**: 統合された基準でコードを評価
4. **⭐️ 評価生成**: 各次元で5段階評価を算出
5. **アクションプラン**: 優先順位付きの改善提案を生成

#### シンプルモードの場合

1. **並列エージェント起動**: 4つのサブエージェントを同時実行
   - **Security Agent**: セキュリティ観点（OWASP Top 10等）
   - **Performance Agent**: パフォーマンス観点（メモリ、レンダリング）
   - **Quality Agent**: コード品質観点（可読性、保守性）
   - **Architecture Agent**: アーキテクチャ観点（依存関係、レイヤー分離）
2. **結果集約**: 各エージェントの結果をマージ
3. **優先度付け**: 重要度と影響度で問題をソート
4. **即時修正提案**: 自動修正可能な項目を特定

#### PRレビュー修正モードの場合

1. **PR情報取得**:
   - コマンドライン引数からPR番号を取得
   - または、現在のブランチから自動検出
2. **コメント取得**: GitHub CLIでPRレビューコメントを取得
3. **優先度分類**: コメントをCritical/High/Major/Minorに分類
4. **自動修正**: 修正可能な項目を優先度順に適用
5. **トラッキング**: 修正状況をドキュメント化

### 4. 出力

レビュー結果を日本語で表示：

- 🔴 **高優先度** / 🟡 **中優先度** / 🟢 **低優先度**
- 具体的な `ファイル名:行番号` の参照
- 実際のコード例と改善例
- 実行可能な改善手順
- ⭐️ 評価（詳細モードのみ）

### 5. フォローアップアクション

オプションに応じた追加処理：

- `--fix`: error-fixerエージェントで自動修正を適用
- `--create-issues`: GitHub issueとして問題を登録
- `--learn`: 学習データとして記録し、将来のレビューで活用

## オプション一覧

### モード選択

- `--simple`: シンプルモードを使用（デフォルトは詳細モード）

### 対象指定

- `--staged`: ステージされた変更のみ
- `--recent`: 直前のコミットのみ
- `--branch <name>`: 指定ブランチとの差分

### Serena統合（詳細モードのみ）

- `--with-impact`: API変更の影響分析
- `--deep-analysis`: 深いセマンティック解析
- `--verify-spec`: 仕様との整合性確認

### ワークフロー

- `--fix`: 自動修正を適用
- `--create-issues`: GitHub issue作成
- `--learn`: 学習データ記録

### PRレビュー修正（PRレビューモードのみ）

- `--fix-pr [PR番号]`: PRレビューコメント修正モード
- `--priority <level>`: 修正する優先度（critical/high/major/minor）
- `--bot <name>`: 特定ボットのコメントのみ（例: coderabbitai）
- `--category <cat>`: 特定カテゴリのみ（security/bug/style/etc）
- `--dry-run`: ドライラン（分類のみ、修正なし）

## 使用例

### 例1: 日常的なレビュー

```bash
# ステージされた変更をクイックレビュー
/review --simple --staged

# 問題発見 → 自動修正
/review --simple --fix
```

### 例2: リリース前の包括的レビュー

```bash
# 開発ブランチとの差分を詳細レビュー
/review --branch develop

# 影響分析を含む詳細レビュー
/review --with-impact --create-issues
```

### 例3: 学習と改善

```bash
# レビュー結果を学習データとして記録
/review --learn

# 継続的な品質向上
/review --fix --learn
```

## レビュー観点と評価基準

このコマンドは以下の観点でコードを評価します。

### ⭐️ 5段階評価システム

各次元について1-5の⭐️で評価します：

- **⭐️⭐️⭐️⭐️⭐️ (5/5) 優秀**: 全ての観点で非常に高い品質。ベストプラクティスを一貫して適用。将来の拡張性と保守性を十分に考慮。
- **⭐️⭐️⭐️⭐️☆ (4/5) 良好**: ほとんどの観点で良い品質。軽微な改善点はあるが、全体的に堅実。
- **⭐️⭐️⭐️☆☆ (3/5) 標準**: 基本的な要件は満たしている。いくつかの改善が必要。技術的負債の蓄積リスクあり。
- **⭐️⭐️☆☆☆ (2/5) 要改善**: 重要な問題がある。修正が強く推奨される。将来の問題やバグの可能性が高い。
- **⭐️☆☆☆☆ (1/5) 要再実装**: 根本的な問題がある。設計から見直しが必要。重大なセキュリティや信頼性のリスクを含む。

### 評価次元

#### 1. コード品質 (Code Quality)

**チェック項目**:

- **可読性**: 適切な変数・関数名、コメントの適切性、コードの構造化
- **保守性**: DRY原則の遵守、単一責任原則、適切な抽象化
- **一貫性**: コーディング規約の遵守、命名規則の統一、フォーマットの統一

**問題パターン**:

- 長すぎる関数 (100行超)
- 深すぎるネスト (4階層超)
- 重複コード
- マジックナンバー

#### 2. セキュリティ (Security)

**チェック項目**:

- **入力検証**: ユーザー入力のサニタイゼーション、適切なバリデーション、SQLインジェクション対策
- **認証・認可**: 適切な権限チェック、セッション管理、パスワード処理
- **データ保護**: 機密情報の適切な扱い、暗号化の使用

**問題パターン**:

- ハードコードされた認証情報
- 未検証の外部入力
- 不適切な権限設定
- XSS脆弱性

#### 3. パフォーマンス (Performance)

**チェック項目**:

- **基本的な最適化**: 不要な処理の排除、効率的なアルゴリズム、リソース使用量の考慮
- **スケーラビリティ**: パフォーマンスボトルネックの回避、メモリ使用量の最適化

**問題パターン**:

- N+1クエリ問題
- 不要なループ処理
- メモリリーク
- 非効率なアルゴリズム

#### 4. テスト (Testing)

**チェック項目**:

- **カバレッジ**: 重要な機能のテスト、エッジケースの考慮、適切なテストレベル
- **テスト品質**: 読みやすいテストコード、独立性の確保、メンテナンス性

**評価基準**:

- ⭐️5: 包括的なテスト、高カバレッジ（80%+）、優れたテスト設計
- ⭐️4: 十分なテスト、良好なカバレッジ（70%+）、適切なテスト設計
- ⭐️3: 基本的なテスト、限定的カバレッジ（50%+）、一部改善必要
- ⭐️2: 不十分なテスト、低カバレッジ（30%未満）、テスト品質に問題
- ⭐️1: テストなし、またはほぼ無意味なテスト

#### 5. エラーハンドリング (Error Handling)

**チェック項目**:

- **例外処理**: 適切なエラーキャッチ、ユーザーフレンドリーなエラーメッセージ、ログ出力の適切性
- **エラー伝播**: エラーの適切な伝播、復旧可能なエラーの処理
- **型安全**: Result<T,E>パターンの活用（TypeScriptの場合）

**推奨パターン**:

```typescript
type Result<T, E> = { success: true; data: T } | { success: false; error: E };
```

#### 6. アーキテクチャ (Architecture)

**チェック項目**:

- **層分離**: 責任分離、依存関係の適切性
- **拡張性**: 新機能追加の容易さ
- **ドメインモデリング**: ビジネスロジックの表現

**評価基準**:

- ⭐️5: 優れた層分離、高い拡張性、明確なドメインモデル
- ⭐️4: 適切な層分離、良好な拡張性、合理的なモデル
- ⭐️3: 基本的な分離、一部の拡張性、改善余地あり
- ⭐️2: 不十分な分離、拡張困難、モデリングに問題
- ⭐️1: 層が混在、拡張不可能、設計破綻

## 技術スタック別の観点

このコマンドは、プロジェクトの技術スタックに応じて専門的なレビュー観点を適用します。

### TypeScript プロジェクト

TypeScript固有の詳細な観点については、以下を参照してください：

#### 📘 [TypeScript Review Skill](../../typescript/skills/SKILL.md)

#### 主要なTypeScript観点（サマリー）

**型安全性**:

- ⚠️ **any型の排除**: Zero `any` typesを目標
- **型ガードの実装**: `as`アサーションより型ガードを優先
- **strictモード準拠**: tsconfig.jsonで全strictフラグを有効化

**型定義品質**:

- **Interface vs Type**: オブジェクト形状はInterface、Union型はType
- **Generics**: 適切な型制約（extends）を活用
- **Discriminated Unions**: 型安全なパターンマッチング

**エラーハンドリング**:

- **Result<T, E>パターン**: 型安全なエラー表現

```typescript
// 推奨: Result<T, E>パターン
type Result<T, E> = { success: true; data: T } | { success: false; error: E };

function fetchUser(id: string): Result<User, FetchError> {
  // 実装...
}
```

**パフォーマンス**:

- **Type-Only Imports**: `import type { User }` でバンドルサイズ最適化
- 複雑な型定義の回避

詳細な評価基準、Before/Afterのコード例、よくある問題と解決策については、上記のTypeScriptスキルドキュメントを参照してください。

### その他の技術スタック

以下のスキルが利用可能です（このリポジトリまたは`~/.claude/skills/`にインストールされている場合）：

- **react**: React + Hooks固有の観点（パフォーマンス最適化、コンポーネント設計）
- **golang**: Go言語のイディオム（エラーハンドリング、並行性）
- **security**: セキュリティ観点（OWASP準拠、入力検証）
- **clean-architecture**: アーキテクチャパターン（層分離、依存規則）

これらのスキルは、`code-review`スキルによって自動的に統合されます。

## トラブルシューティング

### チェックポイント作成が失敗する

```bash
# 変更がない場合は正常
# 既存のチェックポイントがある場合も問題なし
```

### GitHub issue作成が失敗する

```bash
# gh CLIがインストールされているか確認
gh --version

# 認証状態を確認
gh auth status
```

### Serenaオプションが動作しない

```bash
# Serena MCPサーバーが設定されているか確認
# .claude/mcp.json を確認
```

## 関連コマンド

- `/fix`: 直接エラー修正を実行（error-fixerエージェント）
- `/todos`: TODOリスト管理
- `/learnings`: 学習データ閲覧
- `/task`: 汎用タスク実行

## 📚 関連情報

このコマンドは `code-review` スキルに処理を委譲します。スキルとは、Claude Codeの拡張機能で、特定のタスクに特化した知識とワークフローを提供します。

### スキルシステム

**code-review スキル**は以下のような高度な機能を提供します：

- プロジェクトタイプの自動検出（TypeScript、React、Go等）
- 技術スタック別の専門的なレビュー観点の自動統合
- ⭐️ 5段階評価システム
- セマンティック解析（Serena統合）による影響範囲分析
- GitHub統合（issue作成、PRコメント処理）

### 技術スタック別の統合スキル

プロジェクトに応じて以下のスキルが自動的に統合されます：

- **typescript**: 型安全性、strictモード、型ガード、Result<T,E>パターン
- **react**: Hooks、パフォーマンス最適化、コンポーネント設計
- **golang**: イディオム、エラーハンドリング、並行性パターン
- **security**: 入力検証、認証・認可、データ保護（OWASP準拠）
- **clean-architecture**: レイヤー分離、依存規則、ドメインモデリング
- **semantic-analysis**: シンボルレベル解析、影響範囲追跡

これらのスキルは、このリポジトリのコマンドをコピーするだけでは利用できません。完全な機能を使用するには、スキル定義も含めた完全なセットアップが必要です

---

**目標**: プロジェクトに最適化された、実用的で一貫性のあるコードレビューを提供すること。
