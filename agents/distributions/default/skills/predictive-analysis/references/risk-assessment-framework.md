# リスク評価フレームワーク

予測的コード分析におけるリスク評価の詳細な基準と手法を定義します。

## リスクレベル定義

### Critical (緊急)

**特徴**:

- 本番環境で即座に問題を引き起こす可能性が高い
- セキュリティ脆弱性、データ損失リスク
- システムダウンの可能性

**対応期限**: 即座 (24時間以内)

**判定基準**:

- 発生可能性: 高 (>60%)
- 影響度: 甚大 (サービス停止、データ損失、セキュリティ侵害)
- 既知の攻撃パターンや脆弱性に該当

**例**:

```typescript
// Critical: SQLインジェクション脆弱性
const query = `SELECT * FROM users WHERE id = ${userId}`;
db.execute(query);

// Critical: 認証なしの管理者機能アクセス
app.get("/admin/delete-user", (req, res) => {
  User.delete(req.query.id);
});
```

### High (高)

**特徴**:

- 近い将来 (数週間〜数ヶ月) に問題が発生する可能性
- パフォーマンス劣化、データ整合性の問題
- スケーラビリティの制約

**対応期限**: 1週間以内

**判定基準**:

- 発生可能性: 中〜高 (40-60%)
- 影響度: 大 (パフォーマンス劣化、機能停止)
- トラフィック増加やデータ増加で顕在化

**例**:

```typescript
// High: O(n²) のパフォーマンスボトルネック
users.forEach((user) => {
  user.orders = orders.filter((o) => o.userId === user.id);
});

// High: メモリリークの可能性
const cache = {};
function addToCache(key, value) {
  cache[key] = value; // 削除処理なし
}
```

### Medium (中)

**特徴**:

- 長期的に保守性やコード品質に影響
- 技術的負債の蓄積
- リファクタリングの必要性

**対応期限**: 1ヶ月以内

**判定基準**:

- 発生可能性: 中 (20-40%)
- 影響度: 中 (保守コスト増加、バグ増加)
- コードの変更頻度が高い箇所

**例**:

```typescript
// Medium: 高い循環的複雑度 (McCabe > 15)
function processOrder(order: Order) {
  if (order.type === "standard") {
    if (order.priority === "high") {
      if (order.customer.isPremium) {
        // 深いネスト、15以上の分岐
      }
    }
  }
}

// Medium: コード重複
function validateUserEmail(email) {
  /* ... */
}
function validateAdminEmail(email) {
  /* ... */
} // 同じロジック
```

### Low (低)

**特徴**:

- 長期的な品質向上の機会
- ベストプラクティスからの逸脱
- 最適化の余地

**対応期限**: 次回リファクタリング時

**判定基準**:

- 発生可能性: 低 (<20%)
- 影響度: 小 (コード品質、可読性)
- 優先度の低い改善項目

**例**:

```typescript
// Low: 命名規則の不統合
const user_data = getUserData();
const orderInfo = getOrderInfo(); // スネークケースとキャメルケースの混在

// Low: 未使用のインポート
import { unused } from "library";
```

## リスク評価マトリクス

### 4象限マトリクス

```
影響度
  高 │ Medium │ Critical
     │        │
     │───────┼───────
     │        │
  低 │   Low  │  High
     │        │
     └────────┴────────
       低   発生可能性   高
```

### スコアリング計算式

```
Risk Score = (Likelihood × Impact) + Urgency Factor

Likelihood (発生可能性): 1-10
Impact (影響度): 1-10
Urgency Factor (緊急性): 0-20

Total Score:
  80-100: Critical
  60-79:  High
  40-59:  Medium
  0-39:   Low
```

## 評価基準詳細

### 1. 発生可能性 (Likelihood)

| スコア | 確率    | 判定基準                               |
| ------ | ------- | -------------------------------------- |
| 9-10   | 90-100% | 既知の脆弱性、明らかなバグ             |
| 7-8    | 70-90%  | 高負荷時に確実に発生、実績あり         |
| 5-6    | 50-70%  | 一般的なアンチパターン、条件次第で発生 |
| 3-4    | 30-50%  | 特定の条件下で発生の可能性             |
| 1-2    | 0-30%   | 理論上の問題、発生条件が限定的         |

**評価要素**:

- コードの変更頻度 (高頻度 = 高リスク)
- 依存関係の複雑さ (複雑 = 高リスク)
- テストカバレッジ (低カバレッジ = 高リスク)
- 過去の不具合履歴 (多い = 高リスク)

### 2. 影響度 (Impact)

| スコア | レベル | 影響範囲                                   |
| ------ | ------ | ------------------------------------------ |
| 9-10   | 甚大   | サービス停止、データ損失、セキュリティ侵害 |
| 7-8    | 大     | 主要機能停止、パフォーマンス劣化           |
| 5-6    | 中     | 一部機能の制限、ユーザー体験の低下         |
| 3-4    | 小     | 軽微な不具合、保守性の低下                 |
| 1-2    | 微小   | コード品質、開発者体験への影響のみ         |

**評価要素**:

- 影響を受けるユーザー数
- ビジネスクリティカルな機能への影響
- データの重要性
- 回復可能性

### 3. タイムライン (Timeline)

問題が顕在化する時期の予測:

| 期間         | 説明                               | 緊急性スコア |
| ------------ | ---------------------------------- | ------------ |
| 即座         | 既に問題が発生している、または数日 | +20          |
| 短期 (1週間) | 近い将来確実に発生                 | +15          |
| 中期 (1ヶ月) | 条件次第で数週間〜数ヶ月           | +10          |
| 長期 (3ヶ月) | 長期的な技術的負債                 | +5           |

**予測要素**:

- トラフィック成長率
- データ増加率
- 機能拡張の計画
- 既知の制約事項

### 4. 修正コスト (Effort)

| 現在の修正コスト | 将来の修正コスト | コスト倍率 | 優先度調整 |
| ---------------- | ---------------- | ---------- | ---------- |
| 1時間            | 1日              | 8x         | +高        |
| 1日              | 1週間            | 5x         | +中        |
| 1週間            | 1ヶ月            | 4x         | +中        |
| 1ヶ月            | 3ヶ月            | 3x         | +低        |

**考慮要素**:

- コードの依存関係の広がり (早期修正ほど局所化)
- テストの追加難易度
- 既存機能への影響範囲
- チームの知識レベル

## リスクカテゴリ別の評価基準

### セキュリティリスク

**評価の重点**:

- OWASP Top 10 への該当
- 認証・認可の不備
- データ露出の可能性

**自動的に Critical とする条件**:

- SQLインジェクション、XSSの脆弱性
- 認証なしの管理者機能アクセス
- ハードコードされたシークレット情報

### パフォーマンスボトルネック

**評価の重点**:

- アルゴリズムの時間計算量
- データ量の増加に対するスケーラビリティ
- リソース使用効率

**Critical/High の判定基準**:

- O(n²) 以上のアルゴリズムがメインパスに存在
- メモリリークの明確な証拠
- データベースクエリの N+1 問題

### 技術的負債

**評価の重点**:

- 循環的複雑度 (McCabe Complexity)
- コード重複率
- 保守性指標 (Maintainability Index)

**High/Medium の判定基準**:

- 循環的複雑度 > 15
- コード重複 > 10%
- 変更頻度が高く、バグ密度も高い

## 評価プロセス

### ステップ1: パターン検出

```
1. 既知の問題パターンをスキャン
2. 静的解析ツールの結果を統合
3. メトリクスの閾値チェック
```

### ステップ2: コンテキスト分析

```
1. プロジェクトの種別・規模を考慮
2. ビジネスクリティカリティを評価
3. 変更履歴と不具合履歴を確認
```

### ステップ3: リスクスコア算出

```
1. Likelihood と Impact を個別に評価
2. Timeline に基づく緊急性スコアを追加
3. 総合スコアからリスクレベルを判定
```

### ステップ4: 修正提案の生成

```
1. リスク軽減戦略を検索
2. 修正コストを見積もり
3. 優先度付きの対応計画を提案
```

## 特殊なケースの取り扱い

### レガシーコードの評価

- 変更頻度が低い場合は優先度を下げる
- 既存テストで保護されている場合はリスクを軽減
- 段階的な改善計画を提案

### サードパーティ依存の評価

- CVE データベースでの脆弱性確認
- メンテナンス状況の評価
- 代替ライブラリの検討

### プロトタイプコードの評価

- 本番環境への影響範囲を限定
- 明確な移行計画の有無を確認
- 技術的負債の可視化を優先
